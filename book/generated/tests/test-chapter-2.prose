# Test B: Writer-led research
# Chapter 2: The Death of the Gods
#
# Approach: Writer does its own research as it writes, reading full lectures directly
#
# IMPORTANT: First read ~/www/cybertantra/book/generated/REPO-MAP.md for file locations

agent writer:
  model: opus
  prompt: """
You are writing a chapter for a founding religious text on Cyber Tantra.

YOUR TASK: Let the source material speak. Your job is arrangement and transmission, not synthesis.

YOU HAVE ACCESS TO THE FULL CORPUS. Use it.

FIRST: Read ~/www/cybertantra/book/generated/REPO-MAP.md - it has all file locations and a topicâ†’lecture index.

Corpus is at: /home/gorkolas/www/cybertantra/transcriptions/@corpus/
Use Read to load full lectures. Don't search - the REPO-MAP tells you which files cover which topics.

As you write, if you need more source material on a topic:
1. Search the corpus for relevant lectures
2. Read the full lecture (not snippets)
3. Draw directly from what you find

You can also query the Cybertantra bot for guidance on which lectures cover a topic:
curl -s -X POST https://cybertantra-omega.vercel.app/api/query \
  -H "Content-Type: application/json" \
  -H "x-api-key: 7d5dbd3f1fea707b91e3120a68b6bc006d1dabe29af34a9c877df1d4d488ebb3" \
  -d '{"question": "Which lectures discuss [TOPIC]?", "topK": 5}'

WHAT TO DO:
- Use the source's own words and phrases as much as possible
- Arrange passages into logical flow with minimal connecting tissue
- When you must bridge between ideas, keep it brief
- Preserve specific terminology (thumos, manipura, Dattatreya, etc.)
- Let claims stand without hedging - if the source says it, say it
- Direct quotes are good - weave them in naturally

WHAT NOT TO DO:
- Don't add concepts not in the source material
- Don't soften or qualify claims the source makes boldly
- Don't add defensive insertions ("This is not metaphor", "Some might say")
- Don't invent examples or analogies not grounded in source

If you can't find source material on a topic, flag it: [NEEDS SOURCE: topic]

OUTPUT: 1500-2500 words. End on strong images from the source, not summaries.
"""

agent reviewer:
  model: opus
  prompt: """
You review draft chapters for a founding religious text.

CHECK FOR:
1. OVER-SYNTHESIS - Has the writer paraphrased too much? The source language should come through directly.
2. DEFENSIVE HEDGING - Look for: "This is not metaphor", "Some might say". Delete these.
3. INVENTED CONTENT - Is everything grounded in source? Flag anything that looks added.
4. [NEEDS SOURCE] FLAGS - Note any gaps the writer flagged.

OUTPUT:
- PASS: Chapter is ready
- REVISE: List specific issues with quoted passages and concrete fixes
"""

# =============================================================================
# SINGLE CHAPTER TEST - WRITER-LED
# =============================================================================

session "Load repo map"
  prompt: "Read ~/www/cybertantra/book/generated/REPO-MAP.md to understand file locations"

session "Starting Chapter 2: The Death of the Gods (Writer-led approach)"

# No separate research phase - writer does it as needed
let draft = session: writer
  prompt: """
  Write Chapter 2: The Death of the Gods

  Topics to cover:
  - The decline of Abrahamism and monotheism
  - Why the old gods failed / what killed them
  - The vacuum left behind (secularism, atheism, nihilism)
  - The polytheistic revival / return of the gods
  - Nietzsche's "God is dead" and what comes after

  START by searching the corpus for relevant lectures. Read them fully.
  Then arrange the material into a chapter.

  Corpus: ~/www/cybertantra/transcriptions/@corpus/

  1500-2500 words. Use the source's own language.
  """

# Review
let review = session: reviewer
  prompt: "Review this chapter draft."
  context: draft

# Revise if needed
if **review says REVISE**:
  draft = session: writer
    prompt: """
    Revise based on this feedback:
    {review}

    Go back to the corpus if you need more source material.
    """
    context: { draft, review }

# Save
session "Save chapter"
  prompt: """
  Save the final chapter to:
  ~/www/cybertantra/book/generated/chapters/02-the-death-of-the-gods-B.md
  """
  context: draft

session "Done - Chapter 2 complete (writer-led approach)"
